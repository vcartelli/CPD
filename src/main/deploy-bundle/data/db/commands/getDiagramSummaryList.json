{
  "aggregate": "model",
  "pipeline": [
    {
      "$match": {
        "class": "model.FPMN.Procedure"
      }
    },
    {
      "$lookup": {
        "from": "diagram",
        "localField": "_id",
        "foreignField": "modelId",
        "as": "diagram"
      }
    },
    {
      "$unwind": "$diagram"
    },
    {
      "$match": {
        "diagram.class": "diagram.Root"
      }
    },
    {
      "$lookup": {
        "from": "model",
        "localField": "_id",
        "foreignField": "parentId",
        "as": "phases"
      }
    },
    {
      "$unwind": "$phases"
    },
    {
      "$match": {
        "$and": [
          {"phases.class":"model.FPMN.Phase"},
          {"phases.nextPhaseId": null}
        ]
      }
    },
    {
      "$graphLookup": {
        "from": "model",
        "startWith": "$phases._id",
        "connectFromField": "prevPhaseId",
        "connectToField": "_id",
        "as": "phases"
      }
    },
    {
      "$addFields": {
        "phases": {
          "$map": {
            "input": "$phases",
            "as": "phase",
            "in": {
              "eServiceId" : "$$phase.eServiceId",
              "name": "$$phase.name",
              "documentation": "$$phase.documentation"
            }
          }
        }
      }
    },
    {
      "$project": {
        "_id": 0,
        "diagramId": "$diagram._id",
        "notation": "$notation",
        "name": "$name",
        "documentation": "$documentation",
        "phases":"$phases",
        "url": {
          "$concat": [
            "{appDiagramUrl}",
            "$diagram._id"
          ]
        },
        "svg": {
          "$concat": [
            "{appDiagramSvg}",
            "$diagram._id",
            ".svg"
          ]
        }
      }
    }
  ]
}
